# Architecture

**Analysis Date:** 2026-01-27

## Pattern Overview

**Overall:** OpenAPI-to-NestJS Code Generator with Hex Pattern

**Key Characteristics:**
- Adapter pattern for external dependencies (SwaggerParser, FileWriter)
- Port-based architecture using TypeScript interfaces
- Generator-based code synthesis using AST manipulation
- Unidirectional data flow: OpenAPI spec → AST → TypeScript files
- Strong separation of concerns: parsing, mapping, generation, and I/O

## Layers

**Port Layer (Abstractions):**
- Purpose: Define contracts for pluggable components
- Location: `G:/Projects/opennest/interfaces/core.ts`
- Contains: `ISpecParser`, `IGenerator`, `IFileWriter` interfaces
- Depends on: openapi-types (for OpenAPI type definitions)
- Used by: All generators and adapters

**Core Utilities Layer:**
- Purpose: Transform OpenAPI schemas to TypeScript types with decorators
- Location: `G:/Projects/opennest/utils/type-mapper.ts`
- Contains: `TypeMapper` class with schema mapping logic
- Depends on: Port layer, openapi-types
- Used by: DTO generator

**Generator Layer:**
- Purpose: Convert OpenAPI specifications into AST nodes and TypeScript source code
- Location: `G:/Projects/opennest/generators/`
- Contains: Four generators implementing `IGenerator`
  - `DtoGenerator`: Transforms schemas into DTO classes with validation decorators
  - `ControllerGenerator`: Creates controller classes with route handlers
  - `DecoratorGenerator`: Generates endpoint-level Swagger decorators
  - `CommonGenerator`: Produces shared artifacts (error DTOs, auth decorators)
- Depends on: Port layer, TypeMapper, ts-morph for AST manipulation
- Used by: Bootstrap orchestrator

**Adapter Layer (Implementation Details):**
- Purpose: Concrete implementations of port interfaces
- Location: `G:/Projects/opennest/main.ts`
- Contains:
  - `SwaggerParserAdapter`: Implements `ISpecParser` using @apidevtools/swagger-parser
  - `SystemFileWriter`: Implements `IFileWriter` using ts-morph Project
- Depends on: Port layer, external libraries (@apidevtools/swagger-parser, ts-morph)
- Used by: Bootstrap orchestrator

**Entry Point/Orchestrator:**
- Purpose: Coordinate dependency injection and execution pipeline
- Location: `G:/Projects/opennest/main.ts` (bootstrap function)
- Triggers: Node runtime execution via `ts-node main.ts`
- Responsibilities: Initialize adapters, set up generators, parse spec, execute generation pipeline, save files

## Data Flow

**OpenAPI Document → Generated NestJS Artifacts:**

1. **Parse Stage**
   - OpenAPI URL/path → `SwaggerParserAdapter.parse()` → Dereferenced OpenAPI Document
   - Validation: strict dereferencing ensures all $ref resolved

2. **Generation Pipeline (Sequential)**
   - Document → `CommonGenerator.generate()` → Common artifacts (error DTO, auth decorators)
   - Document → `DtoGenerator.generate()` → DTO classes with validation decorators
   - Document → `DecoratorGenerator.generate()` → Endpoint decorator functions
   - Document → `ControllerGenerator.generate()` → Controller classes with injected services

3. **Write Stage**
   - In-memory AST Project → `SystemFileWriter.save()` → Formatted files on disk
   - Formatting: 2-space indents, organized imports, newline at EOF

**State Management:**
- Stateless: All generators operate on immutable OpenAPI document
- AST Project acts as shared mutable state for all generators (allows cross-generator references)
- No global state; all dependencies injected via constructor

## Key Abstractions

**TypeMappingResult:**
- Purpose: Carries complete type information from schema to property decorator
- Location: `G:/Projects/opennest/interfaces/core.ts` (interface)
- Holds: TypeScript type string, required imports, decorator definitions, optional enum metadata
- Pattern: Builder-like object accumulating information as schema is processed

**IGenerator:**
- Purpose: Common contract for all code generation logic
- Implementations: DtoGenerator, ControllerGenerator, DecoratorGenerator, CommonGenerator
- Pattern: Strategy pattern for pluggable generators

**EnumDefinition:**
- Purpose: Metadata for generating const and type alias for enums
- Contains: TypeScript type name, const name (UPPER_CASE), list of values
- Generated by: TypeMapper when schema.enum detected
- Used by: DtoGenerator to insert enum definitions before class in file

## Entry Points

**Application Entry:**
- Location: `G:/Projects/opennest/main.ts` (bootstrap function)
- Triggers: `npm start` (ts-node main.ts)
- Responsibilities:
  1. Instantiate all adapters (parser, fileWriter)
  2. Instantiate all generators with dependencies
  3. Create in-memory AST Project
  4. Parse OpenAPI spec from `http://localhost:5300/docs-json`
  5. Execute generators in sequence
  6. Save formatted output to disk

**Generator Entry Points:**
- Each implements `IGenerator.generate(document, project)` signature
- Called sequentially from bootstrap function
- Order matters: CommonGenerator first (shared artifacts), then DTO, Decorator, Controller

## Error Handling

**Strategy:** Try-catch in bootstrap with direct console.error propagation

**Patterns:**
- Parser: Swagger dereferencing validates schema, throws if invalid
- Generators: No explicit error handling; rely on ts-morph exceptions
- File I/O: fs errors propagate through Project.save()
- Validation: NestJS decorators are additive; invalid combinations ignored (no validation)

## Cross-Cutting Concerns

**Logging:** Console.log statements in bootstrap and adapters for progress tracking

**Validation:** Delegated to class-validator decorators in generated DTOs (not in generator logic)

**Type Safety:**
- OpenAPI types via openapi-types package
- Strict TypeScript compilation (strict: true in tsconfig.json)
- Decorator metadata preserved via experimentalDecorators and emitDecoratorMetadata

---

*Architecture analysis: 2026-01-27*
